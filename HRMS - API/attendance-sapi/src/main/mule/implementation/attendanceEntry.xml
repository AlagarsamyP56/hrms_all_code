<?xml version="1.0" encoding="UTF-8"?>

<mule   xmlns:db="http://www.mulesoft.org/schema/mule/db"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd
 ">
	<sub-flow name="attendanceEntrySub_Flow" doc:id="5a84db08-8a40-4a36-8627-fe4f8e47a87c" >
		<until-successful maxRetries="${until.retries}" doc:name="Until Successful" doc:id="b5249097-deec-4cc0-8ba8-510237c10748" millisBetweenRetries="${until.millisecs}">
			<try doc:name="Try" doc:id="4ae41168-7db6-4554-bc31-25486194ac08">
				<logger level="INFO" doc:name="Before posting entry into DB" doc:id="6b7d4c20-c87a-4e29-a307-4fa6aa571449" message="Before posting entry into DB" />
				<db:insert doc:name="posting employee entry records" doc:id="269593f3-cd20-4295-a0de-ba957f2c4a6a" config-ref="Database_Config">
			<db:sql><![CDATA[INSERT INTO public.attendance (employeeid, entrydate, entry)
VALUES (:employeeid, :entrydate, :entry)
ON CONFLICT (employeeid, entrydate)
DO UPDATE SET entry = public.attendance.entry || '|' || EXCLUDED.entry;]]></db:sql>
			<db:input-parameters><![CDATA[#[{entry: payload.Date default ((((now() >> "IST" as String  ) splitBy "T") joinBy " ") [0 to 18])[11 to 15],
	employeeid: payload.EmployeeID,
	
	entrydate: now() as String {format: "dd-MM-YYYY"}
}]]]></db:input-parameters>
		</db:insert>
				<logger level="INFO" doc:name="After posting entry into DB" doc:id="967e1ce0-22e0-4a4b-a681-fa8aa969dd9f" message="After posting entry into DB"/>
				<set-payload value='#[%dw 2.0&#10;output application/json&#10;---&#10;{&#10;  message: "Entries recorded successfully"&#10;}]' doc:name="response" doc:id="f6b33398-ea27-4a4f-80a7-e3327ea83d81" />
				<error-handler ref="db-errorHandler" />
		</try>
		</until-successful>
	</sub-flow>
</mule>
